generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String
  role         Role       @default(OPERATIONS)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  approvals    Approval[]
  stageUpdates StageUpdate[]
}

model Division {
  id             String          @id @default(uuid())
  name           String
  contactPerson  String?
  status         EntityStatus    @default(ACTIVE)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  purchaseOrders PurchaseOrder[]
}

model ProductCategory {
  id        String       @id @default(uuid())
  name      String
  status    EntityStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  products  Product[]
}

model Product {
  id                 String              @id @default(uuid())
  name               String
  categoryId         String
  description        String?
  status             EntityStatus        @default(ACTIVE)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  category           ProductCategory     @relation(fields: [categoryId], references: [id])
  purchaseOrderItems PurchaseOrderItem[]

  @@index([categoryId])
}

model Supplier {
  id             String          @id @default(uuid())
  companyName    String
  contactPerson  String?
  phone          String?
  email          String?
  address        String?
  status         SupplierStatus  @default(ACTIVE)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  purchaseOrders PurchaseOrder[]
}

model PurchaseOrder {
  id                   String              @id @default(uuid())
  poNumber             String              @unique
  supplierId           String
  poDate               DateTime            @default(now())
  expectedDeliveryDate DateTime?
  status               POStatus            @default(DRAFT)
  currency             String              @default("USD")
  paymentTerms         String?
  remarks              String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  divisionId           String?
  supplier             Supplier            @relation(fields: [supplierId], references: [id])
  division             Division?           @relation(fields: [divisionId], references: [id])
  items                PurchaseOrderItem[]
  stageUpdates         StageUpdate[]
  approvals            Approval[]

  @@index([supplierId])
  @@index([divisionId])
}

model PurchaseOrderItem {
  id            String        @id @default(uuid())
  poId          String
  productName   String
  sku           String?
  quantity      Int
  unitPrice     Decimal
  totalPrice    Decimal
  remarks       String?
  productId     String?
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id])
  product       Product?      @relation(fields: [productId], references: [id])

  @@index([poId])
  @@index([productId])
}

model StageUpdate {
  id            String        @id @default(uuid())
  poId          String
  stage         String
  notes         String?
  attachmentUrl String?
  photoUrl      String?
  updatedBy     String?
  timestamp     DateTime      @default(now())
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id])
  updatedByUser User?         @relation(fields: [updatedBy], references: [id])

  @@index([poId])
  @@index([updatedBy])
}

model Approval {
  id            String        @id @default(uuid())
  poId          String
  approverId    String
  level         Int
  decision      String
  remarks       String?
  timestamp     DateTime      @default(now())
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id])
  approver      User          @relation(fields: [approverId], references: [id])

  @@index([poId])
  @@index([approverId])
}

enum Role {
  ADMIN
  PURCHASE_MANAGER
  OPERATIONS
  FINANCE
}

enum EntityStatus {
  ACTIVE
  SUSPENDED
  BLACKLISTED
}

enum SupplierStatus {
  ACTIVE
  SUSPENDED
  BLACKLISTED
}

enum POStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  SENT_TO_SUPPLIER
  IN_PRODUCTION
  QUALITY_INSPECTION
  READY_TO_SHIP
  SHIPPED
  IN_TRANSIT
  PORT_CLEARANCE
  DELIVERED
  CLOSED
  CANCELLED
}
