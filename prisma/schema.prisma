generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id               Int                @id @default(autoincrement())
  username         String             @unique
  passwordHash     String
  role             Role               @default(OPERATIONS)
  status           UserStatus         @default(ACTIVE)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  approvals        Approval[]
  stageUpdates     StageUpdate[]
  inventoryHistory InventoryHistory[] @relation("InventoryHistoryUpdatedBy")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  DELETED
}

model Division {
  id             Int             @id @default(autoincrement())
  name           String
  contactPerson  String?
  status         EntityStatus    @default(ACTIVE)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  purchaseOrders PurchaseOrder[]
}

model ProductCategory {
  id        Int            @id @default(autoincrement())
  name      String
  status    EntityStatus   @default(ACTIVE)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  products  Product[]
}

model Product {
  id                 Int                 @id @default(autoincrement())
  name               String
  categoryId         Int
  description        String?
  minDeliveryDays    Int                 @default(0)
  status             EntityStatus        @default(ACTIVE)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  category           ProductCategory     @relation(fields: [categoryId], references: [id])
  purchaseOrderItems PurchaseOrderItem[]
  inventory          Inventory?

  @@index([categoryId])
}

model Supplier {
  id             Int             @id @default(autoincrement())
  companyName    String
  contactPerson  String?
  phone          String?
  email          String?
  address        String?
  status         SupplierStatus  @default(ACTIVE)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  purchaseOrders PurchaseOrder[]
  dispatches     Dispatch[]
}

model PurchaseOrder {
  id                   Int                 @id @default(autoincrement())
  poNumber             String              @unique
  supplierId           Int
  poDate               DateTime            @default(now())
  status               POStatus            @default(DRAFT)
  remarks              String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  divisionId           Int?
  supplier             Supplier            @relation(fields: [supplierId], references: [id])
  division             Division?           @relation(fields: [divisionId], references: [id])
  items                PurchaseOrderItem[]
  approvals            Approval[]

  @@index([supplierId])
  @@index([divisionId])
}

model PurchaseOrderItem {
  id                   Int            @id @default(autoincrement())
  poId                 Int
  productName          String?
  sku                  String?
  quantity             Int
  unitPrice            Decimal
  totalPrice           Decimal
  remarks              String?
  productId            Int?
  expectedDeliveryDate DateTime?
  purchaseOrder        PurchaseOrder  @relation(fields: [poId], references: [id])
  product              Product?       @relation(fields: [productId], references: [id])
  dispatchItems        DispatchItem[]
  dispatchedQuantity   Int            @default(0) // Denormalized count

  @@index([poId])
  @@index([productId])
}

model Dispatch {
  id              Int            @id @default(autoincrement())
  supplierId      Int
  dispatchDate    DateTime       @default(now())
  referenceNumber String?        // e.g. Invoice / DO Number
  status          DispatchStatus @default(DRAFT)
  remarks         String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  supplier        Supplier       @relation(fields: [supplierId], references: [id])
  items           DispatchItem[]
  stageUpdates    StageUpdate[]

  @@index([supplierId])
}

model DispatchItem {
  id         Int               @id @default(autoincrement())
  dispatchId Int
  poItemId   Int
  quantity   Int
  
  dispatch   Dispatch          @relation(fields: [dispatchId], references: [id], onDelete: Cascade)
  poItem     PurchaseOrderItem @relation(fields: [poItemId], references: [id])

  @@index([dispatchId])
  @@index([poItemId])
}

model Inventory {
  id        Int                @id @default(autoincrement())
  productId Int                @unique
  quantity  Int                @default(0)
  updatedAt DateTime           @updatedAt
  product   Product            @relation(fields: [productId], references: [id])
  history   InventoryHistory[]
}

model InventoryHistory {
  id            Int       @id @default(autoincrement())
  inventoryId   Int
  type          String    // ADD / SUBTRACT
  quantity      Int
  reason        String?   // e.g., "Manually added"
  updatedBy     Int?      // user ID
  timestamp     DateTime  @default(now())
  inventory     Inventory @relation(fields: [inventoryId], references: [id])
  updatedByUser User?     @relation("InventoryHistoryUpdatedBy", fields: [updatedBy], references: [id])

  @@index([inventoryId])
  @@index([updatedBy])
}

model StageUpdate {
  id            Int           @id @default(autoincrement())
  dispatchId    Int
  stage         String
  notes         String?
  attachmentUrl String?
  photoUrl      String?
  updatedBy     Int?
  timestamp     DateTime      @default(now())
  dispatch      Dispatch      @relation(fields: [dispatchId], references: [id])
  updatedByUser User?         @relation(fields: [updatedBy], references: [id])

  @@index([dispatchId])
  @@index([updatedBy])
}

model Approval {
  id            Int           @id @default(autoincrement())
  poId          Int
  approverId    Int
  level         Int
  decision      String
  remarks       String?
  timestamp     DateTime      @default(now())
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id])
  approver      User          @relation(fields: [approverId], references: [id])

  @@index([poId])
  @@index([approverId])
}

model AuditLog {
  id           Int      @id @default(autoincrement())
  entityType   String   // SUPPLIER, ORDER, DIVISION, PRODUCT_CATEGORY, PRODUCT, INVENTORY, USER, DISPATCH
  entityId     Int      // ID of the entity acted upon
  action       String   // CREATE, UPDATE, DELETE, APPROVE, REJECT, STATUS_CHANGE, SUBMIT, STAGE_UPDATE, LOGIN, STOCK_UPDATE
  userId       Int?     // Who performed the action (null for system actions)
  username     String?  // Denormalized for quick display
  previousData Json?    // Snapshot before the change
  newData      Json?    // Snapshot after the change
  metadata     Json?    // Extra context (e.g. remarks, IP, PO number)
  createdAt    DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
}

enum Role {
  ADMIN
  OPERATIONS
  SALES_MANAGER
}

enum EntityStatus {
  ACTIVE
  SUSPENDED
  BLACKLISTED
  DELETED
}

enum SupplierStatus {
  ACTIVE
  SUSPENDED
  BLACKLISTED
  DELETED
}

enum POStatus {
  DRAFT
  PENDING_L1
  APPROVED_L1
  REJECTED_L1
  ORDER_PLACED
  PARTIALLY_DELIVERED
  FULLY_DELIVERED
  CLOSED
  CANCELLED
  DELETED
}

enum DispatchStatus {
  DRAFT
  PACKED
  SHIPPED
  IN_TRANSIT
  DELIVERED
  RETURNED
  CANCELLED
}
